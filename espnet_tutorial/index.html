<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>class: center, middle, theYellowBackground background: blue</p> <p>.huge.bold[A quick tutorial on how to use<br><br>ESPnet]</p> <hr> <h1 id="table-of-contents">Table of Contents</h1> <ol> <li> <p>Basic directory structure</p> <ul> <li> <p><a href="#espnet_recipe">Recipe</a></p> </li> <li> <p><a href="#espnet_framework">Framework</a></p> </li> </ul> </li> <li> <p><a href="#data_format">Data format</a>: <code class="language-plaintext highlighter-rouge">dump/raw/&lt;subset-name&gt;/</code></p> </li> <li> <p><a href="#task_definition">Task definition</a>: <code class="language-plaintext highlighter-rouge">espnet2/tasks/enh.py</code></p> </li> <li> <p><a href="#model_definition">Model definition</a>: <code class="language-plaintext highlighter-rouge">espnet2/enh/</code></p> </li> <li> <p><a href="#model_configuration">Model configuration</a>: <code class="language-plaintext highlighter-rouge">conf/tuning/xxx.yaml</code></p> </li> <li> <p><a href="#script_flow">Script flow of training and inference</a></p> </li> </ol> <hr> <p>name: espnet_recipe</p> <h1 id="basic-directory-structure---recipe">Basic directory structure - Recipe</h1> <p>.left-column-38[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ urgent24</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh1</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/conf" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ conf</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/local" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ local</a> â”‚ â”œâ”€ .red[ğŸ“ data] â”‚ â”œâ”€ .red[ğŸ“ dump] â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/cmd.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ cmd.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/path.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ path.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.sh</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ run.sh</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-61[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes *** Recipe for a specific dataset **** Speech enhancement recipe ***** Model configurations (YAML files) ***** Data preparation scripts (used by run.sh) ***** .red[Directory generated by local/data.sh] <a href="#data_format" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Data format</code></a> ***** .red[Data directory used for training/evaluation] <a href="#data_format" style="text-decoration:none">ğŸ‘†</a> ***** SLURM config (cmd_backend: 'local' / 'slurm' /...) ***** Envrionment config file (export XXX=YYY) ***** Common script used for speech enhancement ***** .red[Entry script for running the recipe] ** Python scripts used for training/inference ** Used for toolkit installation </div> <p>]</p> <p>.full-column[</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root-dir&gt;/egs2/urgent24/enh1
./run.sh <span class="nt">--stage</span> 1 <span class="nt">--stop-stage</span> 1
<span class="nb">mkdir</span> <span class="nt">-p</span> dump/raw
<span class="nb">cp</span> <span class="nt">-r</span> data/<span class="k">*</span> dump/raw/
</code></pre></div></div> <p>]</p> <hr> <h1 id="basic-directory-structure---recipe-contd">Basic directory structure - Recipe (Contâ€™d)</h1> <p>.left-column-48[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ urgent24</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh1</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/conf" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“ conf</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/local" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ local</a> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ data</span> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ dump</span> â”‚ â”œâ”€ .red[ğŸ“ exp] â”‚ â”‚ â””â”€ .red[ğŸ“ enh_stats_16k] â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/cmd.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ cmd.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/path.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ path.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.sh</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ run.sh</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-51[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes *** Recipe for a specific dataset **** Speech enhancement recipe ***** .red[Model configurations] <a href="#model_configuration" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Model configuration</code></a> ***** Data preparation scripts (used by run.sh) ***** Directory generated by local/data.sh ***** Data directory used for training/evaluation ***** .red[ Exp directory for model training/inference] ****** .red[Length stats used for minibatch construction] ***** SLURM config file ('local', 'slurm', etc.) ***** Envrionment config file (export XXX=YYY) ***** Common script used for speech enhancement ***** .red[Entry script for running the recipe] ** Python scripts used for training/inference ** Used for toolkit installation </div> <p>]</p> <p>.full-column[</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root-dir&gt;/egs2/urgent24/enh1
./run.sh <span class="nt">--stage</span> 5 <span class="nt">--stop-stage</span> 5 <span class="nt">--nj</span> 8
</code></pre></div></div> <p>]</p> <hr> <h1 id="basic-directory-structure---recipe-contd-1">Basic directory structure - Recipe (Contâ€™d)</h1> <p>.left-column-48[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ urgent24</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh1</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/conf" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“ conf</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/local" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ local</a> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ data</span> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ dump</span> â”‚ â”œâ”€ .red[ğŸ“ exp] â”‚ â”‚ â””â”€ .red[ğŸ“ enh_train_enh_xxx_raw] â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/cmd.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ cmd.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/path.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ path.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.sh</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ run.sh</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-51[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes *** Recipe for a specific dataset **** Speech enhancement recipe ***** .red[Model configurations] <a href="#model_configuration" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Model configuration</code></a> ***** Data preparation scripts (used by run.sh) ***** Directory generated by local/data.sh ***** Data directory used for training/evaluation ***** .red[Exp directory for model training/inference] <span> ****** <span style="color:red">Trained model directory</span></span> ***** SLURM config file ('local', 'slurm', etc.) ***** Envrionment config file (export XXX=YYY) ***** Common script used for speech enhancement ***** .red[Entry script for running the recipe] ** Python scripts used for training/inference ** Used for toolkit installation </div> <p>]</p> <p>.full-column[</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root-dir&gt;/egs2/urgent24/enh1
./run.sh <span class="nt">--stage</span> 6 <span class="nt">--stop-stage</span> 6 <span class="nt">--enh_config</span> conf/tuning/xxx.yaml <span class="nt">--num_nodes</span> 1 <span class="nt">--ngpu</span> 1
</code></pre></div></div> <p>]</p> <hr> <h1 id="basic-directory-structure---recipe-contd-2">Basic directory structure - Recipe (Contâ€™d)</h1> <p>.left-column-48[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ urgent24</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh1</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/conf" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“ conf</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/local" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ local</a> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ data</span> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ dump</span> â”‚ â”œâ”€ .red[ğŸ“ exp] â”‚ â”‚ â””â”€ .red[ğŸ“ enh_train_enh_xxx_raw] â”‚ â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ images</span> â”‚ â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“„ 1epoch.pth</span> â”‚ â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“„ valid.loss.best.pth</span> â”‚ â”‚ â””â”€ <span style="color:#004276;">ğŸ“„ train.log</span> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/cmd.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ cmd.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/path.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ path.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.sh</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ run.sh</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-51[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes *** Recipe for a specific dataset **** Speech enhancement recipe ***** .red[Model configurations] <a href="#model_configuration" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Model configuration</code></a> ***** Data preparation scripts (used by run.sh) ***** Directory generated by local/data.sh ***** Data directory used for training/evaluation ***** .red[Exp directory for model training/inference] <span> ****** <span style="color:red">Trained model directory</span></span> <span> ****** <span style="color:#004276;">Training curves</span></span> <span> ****** <span style="color:#004276;">Latest checkpoint</span></span> <span> ****** <span style="color:#004276;">Best checkpoint (when finished)</span></span> <span> ****** <span style="color:#004276;">Training log</span></span> ***** SLURM config file ('local', 'slurm', etc.) ***** Envrionment config file (export XXX=YYY) ***** Common script used for speech enhancement ***** .red[Entry script for running the recipe] ** Python scripts used for training/inference ** Used for toolkit installation </div> <p>]</p> <hr> <h1 id="basic-directory-structure---recipe-contd-3">Basic directory structure - Recipe (Contâ€™d)</h1> <p>.left-column-48[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ urgent24</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh1</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/conf" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“ conf</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/local" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ local</a> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ data</span> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ dump</span> â”‚ â”œâ”€ .red[ğŸ“ exp] â”‚ â”‚ â””â”€ .red[ğŸ“ enh_train_enh_xxx_raw] â”‚ â”‚ â””â”€ .red[ğŸ“ enhanced_validation] â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/cmd.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ cmd.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/path.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ path.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.sh</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ run.sh</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-51[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes *** Recipe for a specific dataset **** Speech enhancement recipe ***** .red[Model configurations] <a href="#model_configuration" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Model configuration</code></a> ***** Data preparation scripts (used by run.sh) ***** Directory generated by local/data.sh ***** Data directory used for training/evaluation ***** .red[Exp directory for model training/inference] <span> ****** <span style="color:red">Trained model directory</span></span> <span> ******* <span style="color:red">Enhanced audios (spk1.scp)</span></span> ***** SLURM config file ('local', 'slurm', etc.) ***** Envrionment config file (export XXX=YYY) ***** Common script used for speech enhancement ***** .red[Entry script for running the recipe] ** Python scripts used for training/inference ** Used for toolkit installation </div> <p>]</p> <p>.full-column[</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root-dir&gt;/egs2/urgent24/enh1
./run.sh <span class="nt">--stage</span> 7 <span class="nt">--stop-stage</span> 7 <span class="nt">--enh_config</span> conf/tuning/xxx.yaml <span class="nt">--inference_nj</span> 8 <span class="nt">--gpu_inference</span> 8
</code></pre></div></div> <p>]</p> <hr> <h1 id="basic-directory-structure---recipe-contd-4">Basic directory structure - Recipe (Contâ€™d)</h1> <p>.left-column-48[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ urgent24</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh1</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/conf" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“ conf</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/local" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ local</a> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ data</span> â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ dump</span> â”‚ â”œâ”€ .red[ğŸ“ exp] â”‚ â”‚ â””â”€ .red[ğŸ“ enh_train_enh_xxx_raw] â”‚ â”‚ â””â”€ .red[ğŸ“ enhanced_validation] â”‚ â”‚ â”œâ”€ <span style="color:#004276;">ğŸ“ logdir</span> â”‚ â”‚ â””â”€ <span style="color:#004276;">ğŸ“„ spk1.scp</span> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/cmd.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ cmd.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/path.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ path.sh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.sh</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ run.sh</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-51[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes *** Recipe for a specific dataset **** Speech enhancement recipe ***** .red[Model configurations] <a href="#model_configuration" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Model configuration</code></a> ***** Data preparation scripts (used by run.sh) ***** Directory generated by local/data.sh ***** Data directory used for training/evaluation ***** .red[Exp directory for model training/inference] <span> ****** <span style="color:red">Trained model directory</span></span> <span> ******* <span style="color:red">Enhanced audios (spk1.scp)</span></span> <span> ******** <span style="color:#004276;">Enhanced audio directory</span></span> <span> ******** <span style="color:#004276;">list of all enhanced audios</span></span> ***** SLURM config file ('local', 'slurm', etc.) ***** Envrionment config file (export XXX=YYY) ***** Common script used for speech enhancement ***** .red[Entry script for running the recipe] ** Python scripts used for training/inference ** Used for toolkit installation </div> <p>]</p> <hr> <p>name: espnet_framework</p> <h1 id="basic-directory-structure---framework">Basic directory structure - Framework</h1> <p>.left-column-38[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/egs2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2</a> â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ espnet2</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/bin" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ bin</a> â”‚ â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/bin/enh_train.py" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh_train.py</a> â”‚ â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/bin/enh_inference.py" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ enh_inference.py</a> â”‚ â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/bin/enh_scoring.py" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ enh_scoring.py</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/tasks" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tasks</a> â”‚ â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/tasks/abs_task.py" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“„ abs_task.py</a> â”‚ â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/tasks/enh.py" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ enh.py</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ enh</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/encoder" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ encoder</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/separator" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ separator</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/decoder" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ decoder</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/layers" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ layers</a> â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/loss" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ loss</a> â”‚ â”‚ â”œâ”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/loss/criterions" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ criterions</a> â”‚ â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/loss/wrappers" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ wrappers</a> â”‚ â””â”€ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/espnet_model.py" style="text-decoration:none; color:red;" rel="external nofollow noopener" target="_blank">ğŸ“„ espnet_model.py</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/tools" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ tools</a> </div> <p>]</p> <p>.right-column-61[</p> <div class="code-like-block remark-code"> * Root directory ** Directory containing all recipes ** Python scripts used for training/inference *** Entry scripts (used by <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1/enh.sh" style="text-decoration:none" rel="external nofollow noopener" target="_blank">enh.sh</a>) **** Entry script for training **** .red[Entry script for inference (enhancing a subset)] **** Entry script for scoring (evaluating enhanced audios) *** Task definition **** Abstract task definition (shared by all tasks) **** .red[Speech enhancement task definition] <a href="#task_definition" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Task definition</code></a> *** Speech enhancement model definition <a href="#model_definition" style="text-decoration:none">ğŸ‘‰ <code class="remark-inline-code">Model definition</code></a> **** Available encoders (<a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/encoder/stft_encoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">STFT</a>, <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/encoder/conv_encoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">Conv1d</a>, etc.) **** Available separators (<a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/separator/bsrnn_separator.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">BSRNN</a>, <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/separator/tfgridnetv3_separator.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">TF-GridNet</a>, etc.) **** Available decoders (<a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/decoder/stft_decoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">iSTFT</a>, <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/decoder/conv_decoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">ConvTranspose1d</a>, etc.) **** Detailed layer definitions used in separators *** Loss functions **** Criterion functions (<a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/loss/criterions/time_domain.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">time</a> / <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/loss/criterions/tf_domain.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">time-frequency</a> domain) **** Wrappers (<a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/loss/wrappers/fixed_order.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">fixed permutation</a>, <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/loss/wrappers/pit_solver.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">PIT</a>, etc.) *** .red[Common framework of speech enhancement models] ** Used for toolkit installation </div> <p>]</p> <hr> <p>name: data_format</p> <h1 id="data-format">Data format</h1> <p>In speech enhancement recipes, we need to prepare the following seven files: .left-column-40[</p> <div class="code-like-block remark-code"> <a href="https://github.com/espnet/espnet" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ [espnet-root-dir]</a> â””â”€ <a href="https://github.com/espnet/espnet/tree/master/egs2/urgent24/enh1" style="text-decoration:none" rel="external nofollow noopener" target="_blank">ğŸ“ egs2/urgent24/enh1</a> â”œâ”€ <span style="color:#004276;">ğŸ“ data</span> â””â”€ <span style="color:#004276;">ğŸ“ dump/raw</span> â”œâ”€ <span style="color:#004276;">ğŸ“ train</span> â”‚ â”œâ”€ <span style="color:red">ğŸ“„ wav.scp</span> â”‚ â”œâ”€ <span style="color:red">ğŸ“„ spk1.scp</span> â”‚ â”œâ”€ <span style="color:red">ğŸ“„ text</span> â”‚ â”œâ”€ <span style="color:red">ğŸ“„ utt2spk</span> â”‚ â”œâ”€ <span style="color:red">ğŸ“„ spk2utt</span> â”‚ â”œâ”€ <span style="color:red">ğŸ“„ utt2fs</span> â”‚ â””â”€ <span style="color:red">ğŸ“„ utt2category</span> â”œâ”€ <span style="color:#004276;">ğŸ“ validation</span> â””â”€ <span style="color:#004276;">ğŸ“ test</span> </div> <p>]</p> <p>.right-column-59[</p> <div class="code-like-block remark-code"> * Root directory ** Recipe for the URGENT 2024 Challenge *** Directory generated by local/data.sh *** Data directory used for training/evaluation **** Training set ***** .red[List of degraded speech (model input)] ***** .red[Corresponding clean speech (label)] ***** .red[Corresponding transcripts (for ASR evaluation)] ***** .red[Corresponding speaker IDs] ***** .red[Generated by utils/utt2spk_to_spk2utt.pl] ***** .red[Corresponding sampling rate in Hz] ***** .red[Corresponding category (for minibatch construction)] **** Validation set **** Test set </div> <p>]</p> <p>.full-column[ In each data file, the data format follows the <a href="https://kaldi-asr.org/doc/data_prep.html" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">Kaldi</a> convention, i.e., a <span style="color:#004276;">table-style</span> format with the first column as the utterance ID (key) and the rest columns as the value. ]</p> <hr> <h1 id="data-format-contd">Data format (Contâ€™d)</h1> <table> <thead> <tr> <th>File name</th> <th>Example content</th> <th>Note</th> </tr> </thead> <tbody> <tr> <td>wav.scp</td> <td> <span style="color:red">uid1</span> /path/to/noisy/uid1.flac</td> <td>Essential</td> </tr> <tr> <td>spk1.scp</td> <td> <span style="color:red">uid1</span> /path/to/clean/uid1.flac</td> <td>Needed in stage 8</td> </tr> <tr> <td>text</td> <td> <span style="color:red">uid1</span> It is also very valuable.</td> <td>Needed in stage 8+</td> </tr> <tr> <td>utt2spk</td> <td> <span style="color:red">uid1</span> sid1</td> <td>Essential</td> </tr> <tr> <td>spk2utt</td> <td> <span style="color:red">sid1</span> uid1 uid7 uid16 uid99</td> <td>Essential</td> </tr> <tr> <td>utt2fs</td> <td> <span style="color:red">uid1</span> 32000</td> <td>Essential for multi-fs data</td> </tr> <tr> <td>utt2category</td> <td> <span style="color:red">uid1</span> 1ch_32000Hz</td> <td>Essential for multi-fs data</td> </tr> </tbody> </table> <blockquote> <p>Note that <code class="language-plaintext highlighter-rouge">utt2fs</code> is required to run model inference in stage 7 of <code class="language-plaintext highlighter-rouge">run.sh</code> so that the enhanced audio can be stored in the correct sampling rate. <br><br> For the officially released validation/test subset (downloaded audios), you will need to generate the above data files manually.</p> </blockquote> <hr> <h1 id="data-format-contd-1">Data format (Contâ€™d)</h1> <p>To manually generate data files for an audio directory <code class="language-plaintext highlighter-rouge">audios</code>, you could run the following commands (assuming all file names are unique):</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> dump/raw/&lt;subset-name&gt;
find audios/ <span class="nt">-iname</span> <span class="s1">'*.flac'</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">'[/.]'</span> <span class="s1">'{print($(NF-1)" "$0)}'</span> | <span class="se">\</span>
    <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> dump/raw/&lt;subset-name&gt;/wav.scp
find audios/ <span class="nt">-iname</span> <span class="s1">'*.flac'</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">'[/.]'</span> <span class="s1">'{print($(NF-1)" "$(NF-1))}'</span> | <span class="se">\</span>
    <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> dump/raw/&lt;subset-name&gt;/utt2spk
find audios/ <span class="nt">-iname</span> <span class="s1">'*.flac'</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">'[/.]'</span> <span class="s1">'{print($(NF-1)" "$(NF-1))}'</span> | <span class="se">\</span>
    <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> dump/raw/&lt;subset-name&gt;/spk2utt
python <span class="nt">-c</span> <span class="s1">'
import soundfile as sf
with open("dump/raw/&lt;subset-name&gt;/utt2fs", "w") as f1:
    with open("dump/raw/&lt;subset-name&gt;/utt2category", "w") as f2:
        with open("dump/raw/&lt;subset-name&gt;/wav.scp", "r") as f3:
            for line in f3:
                uid, path = line.strip().split(maxsplit=1)
                info = sf.info(path)
                f1.write(f"{uid} {info.samplerate}\n")
                f2.write(f"{uid} {info.channels}ch_{info.samplerate}Hz\n")
'</span>
</code></pre></div></div> <hr> <p>name: task_definition</p> <h1 id="task-definition">Task definition</h1> <p>The speech enhancement task <a href="https://github.com/espnet/espnet/tree/master/espnet2/tasks/enh.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">espnet2.tasks.enh.EnhancementTask</code></a> is a high-level class used for model training as well as for loading pre-trained models.</p> <p>It generally defines the supported</p> <ul> <li> <p>.darkred[model architectures] (encoder_choices, separator_choices, decoder_choices)</p> </li> <li> <p>.darkred[loss functions] (loss_wrapper_choices, criterion_choices)</p> <ul> <li> <p>The wrapper is used mainly for handling the permutation problem in speech separation tasks.</p> </li> <li> <p>For single-speaker tasks, please simply use <code class="language-plaintext highlighter-rouge">wrapper: fixed_order</code>.</p> </li> </ul> </li> <li> <p>.darkred[preprocessing] (preprocessor_choices)</p> <ul> <li> <p>used for preprocessing each input sample during both training and inference stages</p> </li> <li> <p>e.g., for data augmentation / dynamic mixing, and normalization</p> </li> </ul> </li> <li> <p>and the .darkred[arguments] used for training.</p> </li> </ul> <hr> <h1 id="task-definition-contd">Task definition (Contâ€™d)</h1> <p>To use a pre-trained speech enhancement model for enhancing audios, you can run the following script:</p> <d-code block="" language="python"> import soundfile as sf from espnet2.bin.enh_inference import SeparateSpeech <br> model = SeparateSpeech( train_config="exp/xxx/config.yaml", model_file="exp/xx/valid.loss.best.pth", normalize_output_wav=True, device="cuda", ) <br> audio, fs = sf.read("/path/to/noisy/utt1.flac") enhanced = model(audio[None, :], fs=fs)[0] </d-code> <hr> <p>name: model_definition</p> <h1 id="model-definition">Model definition</h1> <p>All speech enhancement models generally share the same template defined in <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/espnet_model.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">espnet2.enh.espnet_model.ESPnetEnhancementModel</code></a>, which consists of three modules: <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/encoder" style="text-decoration:none" rel="external nofollow noopener" target="_blank">encoder</a> â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/separator" style="text-decoration:none" rel="external nofollow noopener" target="_blank">separator</a> â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/decoder" style="text-decoration:none" rel="external nofollow noopener" target="_blank">decoder</a>.</p> <p>The main enhancement function is achieved by the separator module, which can be of various architectures, e.g., <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/separator/bsrnn_separator.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">BSRNN</a>, <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/separator/tfgridnetv3_separator.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">TF-GridNet</a>, and so on.</p> <p>To add your own model, you can follow the instructions in <a href="https://github.com/espnet/espnet/blob/master/egs2/TEMPLATE/enh1/README.md#instructions-on-creating-a-new-model" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">egs2/TEMPLATE/enh1/README.md</a>.</p> <hr> <p>name: model_configuration</p> <h1 id="model-configuration">Model configuration</h1> <p>The configuration (YAML) file is defined in <a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/conf/tuning" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">conf/tuning/</code></a>.</p> <p>A typical config file consists of four parts:</p> <p><strong>1.</strong> Basic hyperparameters (1/2)</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">max_epoch</span><span class="pi">:</span> <span class="m">100</span>              <span class="c1"># Max training epochs</span>
<span class="na">batch_type</span><span class="pi">:</span> <span class="s">folded</span>          <span class="c1"># See espnet2/samplers/build_batch_sampler.py</span>
<span class="na">batch_size</span><span class="pi">:</span> <span class="m">4</span>               <span class="c1"># Batch size (number of chunks per minibatch when using the chunk iterator)</span>
<span class="na">iterator_type</span><span class="pi">:</span> <span class="s">chunk</span>        <span class="c1"># Using chunk-based iterator for data loading</span>
<span class="na">chunk_length</span><span class="pi">:</span> <span class="m">200</span>           <span class="c1"># Each training sample will be segmented into overlapped 4-sec (= 200 / 50) chunks</span>
<span class="na">chunk_default_fs</span><span class="pi">:</span> <span class="m">50</span>        <span class="c1"># Used for automatically scaling the chunk length based on the input sampling rate</span>
<span class="na">num_iters_per_epoch</span><span class="pi">:</span> <span class="m">8000</span>   <span class="c1"># Number of samples per epoch (each sample can generate &gt;1 chunks when using the chunk iterator)</span>
<span class="na">num_workers</span><span class="pi">:</span> <span class="m">4</span>              <span class="c1"># Number of parallel workers for data loading</span>
<span class="na">grad_clip</span><span class="pi">:</span> <span class="m">5.0</span>              <span class="c1"># Gradient clipping threshold</span>
<span class="na">optim</span><span class="pi">:</span> <span class="s">adam</span>                 <span class="c1"># Optimizer type (See espnet2/tasks/abs_task.py)</span>
<span class="na">optim_conf</span><span class="pi">:</span>                 <span class="c1"># Optimizer configuration</span>
    <span class="na">lr</span><span class="pi">:</span> <span class="s">1.0e-03</span>             <span class="c1"># See the docstring of torch.optim.Adam</span>
    <span class="na">eps</span><span class="pi">:</span> <span class="s">1.0e-08</span>
    <span class="na">weight_decay</span><span class="pi">:</span> <span class="s">1.0e-05</span>
<span class="na">patience</span><span class="pi">:</span> <span class="m">40</span>                <span class="c1"># Patience for early stopping. If the validation performance does not improve for 40 consecutive epochs, the training will be ended.</span>
</code></pre></div></div> <hr> <h1 id="model-configuration-1">Model configuration</h1> <p>The configuration (YAML) file is defined in <a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/conf/tuning" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">conf/tuning/</code></a>.</p> <p>A typical config file consists of four parts:</p> <p><strong>1.</strong> Basic hyperparameters (2/2)</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">val_scheduler_criterion</span><span class="pi">:</span>    <span class="c1"># Validation scheduler configuration. Used to collect stats for certain epoch-based optimizers that require the validation performance per epoch.</span>
<span class="pi">-</span> <span class="s">valid</span>                     <span class="c1"># Name of the phase for stats recording. Can be 'train' or 'valid'.</span>
<span class="pi">-</span> <span class="s">loss</span>                      <span class="c1"># Name of the stats. Can be any key name in the `stats` dict returned by ESPnetEnhancementModel.forward in espnet2/enh/espnet_model.py.</span>
<span class="na">best_model_criterion</span><span class="pi">:</span>       <span class="c1"># Configuration of recording stats for determining the best-performing checkpoint.</span>
<span class="pi">-</span>   <span class="pi">-</span> <span class="s">valid</span>                 <span class="c1"># Name 1 of the phase for stats recording. Can be 'train' or 'valid'.</span>
    <span class="pi">-</span> <span class="s">loss</span>                  <span class="c1"># Name of the stat. Same as above.</span>
    <span class="pi">-</span> <span class="s">min</span>                   <span class="c1"># The best model 1 is determined by the minimum value of the stat. Can be 'min' or 'max'.</span>
<span class="pi">-</span>   <span class="pi">-</span> <span class="s">valid</span>                 <span class="c1"># Name 2 of the phase for stats recording. Can be 'train' or 'valid'.</span>
    <span class="pi">-</span> <span class="s">acc</span>                   <span class="c1"># Name of the stat. Same as above.</span>
    <span class="pi">-</span> <span class="s">max</span>                   <span class="c1"># The best model 2 is determined by the maximum value of the stat. Can be 'min' or 'max'.</span>
<span class="na">keep_nbest_models</span><span class="pi">:</span> <span class="m">1</span>        <span class="c1"># Number of best models to keep. The best model is determined by `best_model_criterion`.</span>
<span class="na">scheduler</span><span class="pi">:</span> <span class="s">steplr</span>           <span class="c1"># Scheduler type. See scheduler_classes in espnet2/tasks/abs_task.py.</span>
<span class="na">scheduler_conf</span><span class="pi">:</span>             <span class="c1"># Scheduler configuration</span>
    <span class="na">step_size</span><span class="pi">:</span> <span class="m">2</span>            <span class="c1"># See the docstring of torch.optim.lr_scheduler.StepLR</span>
    <span class="na">gamma</span><span class="pi">:</span> <span class="m">0.99</span>
<span class="na">allow_multi_rates</span><span class="pi">:</span> <span class="kc">true</span>     <span class="c1"># Whether to allow loading audios of different sampling rates (If true, special treatment is required in the preprocessor to make sure data of different sampling rates are grouped in different categories (thus minibatches))</span>
</code></pre></div></div> <hr> <h1 id="model-configuration-2">Model configuration</h1> <p>The configuration (YAML) file is defined in <a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/conf/tuning" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">conf/tuning/</code></a>.</p> <p>A typical config file consists of four parts:</p> <p><strong>2.</strong> Preprocessor configuration</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">preprocessor</span><span class="pi">:</span> <span class="s">enh</span>           <span class="c1"># Preprocessor type. See preprocessor_choices in espnet2/tasks/enh.py. The 'enh' preprocessor allows automatic processing of different sampling rates based on the utt2fs and utt2category files.</span>
<span class="na">force_single_channel</span><span class="pi">:</span> <span class="kc">true</span>  <span class="c1"># Whether to force the input audio to be single-channel in the preprocessor.</span>
<span class="na">channel_reordering</span><span class="pi">:</span> <span class="kc">true</span>    <span class="c1"># Whether to reorder the multiple channels of the input audio in the preprocessor.</span>
<span class="na">categories</span><span class="pi">:</span>                 <span class="c1"># List of all possible categories used in dump/raw/*/utt2category files. This is used by the preprocessor to group samples according to their category.</span>
<span class="pi">-</span> <span class="s">1ch_8000Hz</span>                <span class="c1"># For this challenge, the category format can be simply '1ch_{fs}Hz'.</span>
<span class="pi">-</span> <span class="s">1ch_16000Hz</span>
<span class="pi">-</span> <span class="s">1ch_22050Hz</span>
<span class="pi">-</span> <span class="s">1ch_24000Hz</span>
<span class="pi">-</span> <span class="s">1ch_32000Hz</span>
<span class="pi">-</span> <span class="s">1ch_44100Hz</span>
<span class="pi">-</span> <span class="s">1ch_48000Hz</span>
<span class="na">num_spk</span><span class="pi">:</span> <span class="m">1</span>                  <span class="c1"># Number of speakers in the input audio. Should be 1 for single-speaker tasks.</span>
</code></pre></div></div> <hr> <h1 id="model-configuration-3">Model configuration</h1> <p>The configuration (YAML) file is defined in <a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/conf/tuning" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">conf/tuning/</code></a>.</p> <p>A typical config file consists of four parts:</p> <p><strong>3.</strong> Model configuration (1/2)</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">model_conf</span><span class="pi">:</span>                 <span class="c1"># Configuration for espnet2/enh/espnet_model.ESPnetEnhancementModel</span>
    <span class="na">normalize_variance_per_ch</span><span class="pi">:</span> <span class="kc">true</span>     <span class="c1"># Whether to normalize the variance of (each channel of) the input speech</span>
    <span class="na">always_forward_in_48k</span><span class="pi">:</span> <span class="kc">false</span>        <span class="c1"># Whether to always upsample the input speech to 48 kHz for model processing. The model output will be downsampled back to its original sampling rate.</span>
                                        <span class="c1"># When processing data of different sampling rates, this must be true for speech enhancement models that only support one sampling rate.</span>
                                        <span class="c1"># For sampling-frequency-independent (SFI) models such as BSRNN and TF-GridNet-v3, this can be false for more efficient processing.</span>
    <span class="na">categories</span><span class="pi">:</span>             <span class="c1"># Must have the same value as in the preprocessor config (see last slide).</span>
    <span class="pi">-</span> <span class="s">1ch_8000Hz</span>
    <span class="pi">-</span> <span class="s">1ch_16000Hz</span>
    <span class="pi">-</span> <span class="s">1ch_22050Hz</span>
    <span class="pi">-</span> <span class="s">1ch_24000Hz</span>
    <span class="pi">-</span> <span class="s">1ch_32000Hz</span>
    <span class="pi">-</span> <span class="s">1ch_44100Hz</span>
    <span class="pi">-</span> <span class="s">1ch_48000Hz</span>
</code></pre></div></div> <hr> <h1 id="model-configuration-4">Model configuration</h1> <p>The configuration (YAML) file is defined in <a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/conf/tuning" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">conf/tuning/</code></a>.</p> <p>A typical config file consists of four parts:</p> <p><strong>3.</strong> Model configuration (2/2)</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">encoder</span><span class="pi">:</span> <span class="s">stft</span>               <span class="c1"># Encoder type. See encoder_choices in espnet2/tasks/enh.py.</span>
<span class="na">encoder_conf</span><span class="pi">:</span>               <span class="c1"># Encoder configuration.</span>
    <span class="na">n_fft</span><span class="pi">:</span> <span class="m">960</span>              <span class="c1"># FFT size for each window.</span>
    <span class="na">hop_length</span><span class="pi">:</span> <span class="m">480</span>         <span class="c1"># Hop size for the sliding window.</span>
    <span class="na">use_builtin_complex</span><span class="pi">:</span> <span class="kc">true</span>  <span class="c1"># Whether to use PyTorch's builtin complex tensor type.</span>
    <span class="na">default_fs</span><span class="pi">:</span> <span class="m">48000</span>       <span class="c1"># Used for automatically adjusting the STFT window/hop sizes based on the input sampling rate.</span>
                            <span class="c1"># This should be used together with frequency-domain SFI models such as BSRNN and TF-GridNet-v3.</span>
<span class="na">decoder</span><span class="pi">:</span> <span class="s">stft</span>               <span class="c1"># Decoder type. See decoder_choices in espnet2/tasks/enh.py.</span>
<span class="na">decoder_conf</span><span class="pi">:</span>               <span class="c1"># Decoder configuration.</span>
    <span class="na">n_fft</span><span class="pi">:</span> <span class="m">960</span>              <span class="c1"># Same as above. Usually should have the same config as in encoder_conf.</span>
    <span class="na">hop_length</span><span class="pi">:</span> <span class="m">480</span>
    <span class="na">default_fs</span><span class="pi">:</span> <span class="m">48000</span>
<span class="na">separator</span><span class="pi">:</span> <span class="s">bsrnn</span>            <span class="c1"># Separator type. See separator_choices in espnet2/tasks/enh.py.</span>
<span class="na">separator_conf</span><span class="pi">:</span>             <span class="c1"># Separator configuration.</span>
    <span class="na">num_spk</span><span class="pi">:</span> <span class="m">1</span>              <span class="c1"># Number of speakers to separate. Should be 1 for single-speaker tasks.</span>
    <span class="s">...</span>                     <span class="c1"># See espnet2/enh/separator/bsrnn_separator.py.</span>
</code></pre></div></div> <hr> <h1 id="model-configuration-5">Model configuration</h1> <p>The configuration (YAML) file is defined in <a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/conf/tuning" style="text-decoration:none;" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">conf/tuning/</code></a>.</p> <p>A typical config file consists of four parts:</p> <p><strong>4.</strong> Training criterion configuration</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">criterions</span><span class="pi">:</span>                 <span class="c1"># Training criterion configuration.</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mr_l1_tfd</span>         <span class="c1"># The first criterion. See criterion_choices in espnet2/tasks/enh.py.</span>
    <span class="na">conf</span><span class="pi">:</span>                   <span class="c1"># Criterion configuration.</span>
      <span class="na">window_sz</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">256</span><span class="pi">,</span> <span class="nv">512</span><span class="pi">,</span> <span class="nv">768</span><span class="pi">,</span> <span class="nv">1024</span><span class="pi">]</span>  <span class="c1"># See MultiResL1SpecLoss in espnet2/enh/loss/criterions/time_domain.py.</span>
      <span class="na">hop_sz</span><span class="pi">:</span> <span class="kc">null</span>
      <span class="na">eps</span><span class="pi">:</span> <span class="s">1.0e-8</span>
      <span class="na">time_domain_weight</span><span class="pi">:</span> <span class="m">0.5</span>
      <span class="na">normalize_variance</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">wrapper</span><span class="pi">:</span> <span class="s">fixed_order</span>    <span class="c1"># Wrapper type for handling the permutation problem. See loss_wrapper_choices in espnet2/tasks/enh.py.</span>
    <span class="na">wrapper_conf</span><span class="pi">:</span>           <span class="c1"># Wrapper configuration.</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">1.0</span>           <span class="c1"># Loss weight for the first criterion. Can be used for balancing multiple criteria.</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">si_snr</span>            <span class="c1"># The second criterion.</span>
    <span class="na">conf</span><span class="pi">:</span>                   <span class="c1"># Criterion configuration.</span>
      <span class="s">...</span>                   <span class="c1"># See SISNRLoss in espnet2/enh/loss/criterions/time_domain.py.</span>
</code></pre></div></div> <hr> <p>name: script_flow</p> <h1 id="script-flow-of-training-and-inference">Script flow of training and inference</h1> <p><strong>Training:</strong></p> <p><a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">run.sh</a> â†’ <a href="https://github.com/espnet/espnet/blob/master/egs2/TEMPLATE/enh1/enh.sh" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">enh.sh</a> (stage 6) â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/bin/enh_train.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/bin/enh_train.py</a><br> â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/tasks/enh.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/tasks/enh.py</a> <code class="language-plaintext highlighter-rouge">ESPnetEnhancementTask</code> &amp;<br> <a href="https://github.com/espnet/espnet/blob/master/espnet2/tasks/abs_task.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/tasks/abs_task.py</a> <code class="language-plaintext highlighter-rouge">AbsTask.main</code><br> â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/train/trainer.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/train/trainer.py</a> <code class="language-plaintext highlighter-rouge">Trainer.run</code><br></p> <ul> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/train/dataset.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/train/dataset.py</a> <code class="language-plaintext highlighter-rouge">ESPnetDataset</code><br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/train/preprocessor.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/train/preprocessor.py</a> <code class="language-plaintext highlighter-rouge">EnhPreprocessor</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/iterators/chunk_iter_factory.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/iterators/chunk_iter_factory.py</a> <code class="language-plaintext highlighter-rouge">ChunkIterFactory.build_iter</code> (If used)<br> </li> </ul> <p>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/espnet_model.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/espnet_model.py</a> <code class="language-plaintext highlighter-rouge">ESPnetEnhancementModel.forward</code><br></p> <ul> <li>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/encoder/stft_encoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/encoder/stft_encoder.py</a> <code class="language-plaintext highlighter-rouge">STFTEncoder.forward</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/separator/bsrnn_separator.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/separator/bsrnn_separator.py</a> <code class="language-plaintext highlighter-rouge">BSRNNSeparator.forward</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/decoder/stft_decoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/decoder/stft_decoder.py</a> <code class="language-plaintext highlighter-rouge">STFTDecoder.forward</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/loss/wrappers/fixed_order.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/loss/wrappers/fixed_order.py</a> <code class="language-plaintext highlighter-rouge">FixedOrderSolver.forward</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/enh/loss/criterions/time_domain.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/loss/criterions/time_domain.py</a> <code class="language-plaintext highlighter-rouge">SISNRLoss.forward</code> (If used)<br> </li> </ul> <hr> <h1 id="script-flow-of-training-and-inference-contd">Script flow of training and inference (Contâ€™d)</h1> <p><strong>Inference:</strong></p> <p><a href="https://github.com/espnet/espnet/blob/master/egs2/urgent24/enh1/run.sh" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">run.sh</a> â†’ <a href="https://github.com/espnet/espnet/blob/master/egs2/TEMPLATE/enh1/enh.sh" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">enh.sh</a> (stage 7) â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/bin/enh_inference.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/bin/enh_inference.py</a> <code class="language-plaintext highlighter-rouge">SeparateSpeech</code><br></p> <ul> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/tasks/enh.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/tasks/enh.py</a> <code class="language-plaintext highlighter-rouge">ESPnetEnhancementTask</code> &amp;<br> <a href="https://github.com/espnet/espnet/blob/master/espnet2/tasks/abs_task.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/tasks/abs_task.py</a> <code class="language-plaintext highlighter-rouge">AbsTask.build_model_from_file</code><br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/tasks/enh.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/tasks/enh.py</a> <code class="language-plaintext highlighter-rouge">ESPnetEnhancementTask.build_streaming_iterator</code><br> <ul> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/train/iterable_dataset.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/train/iterable_dataset.py</a> <code class="language-plaintext highlighter-rouge">IterableESPnetDataset</code><br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/blob/master/espnet2/train/preprocessor.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/train/preprocessor.py</a> <code class="language-plaintext highlighter-rouge">EnhPreprocessor</code> (If used)<br> </li> </ul> </li> </ul> <p>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/espnet_model.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/espnet_model.py</a> <code class="language-plaintext highlighter-rouge">ESPnetEnhancementModel.forward</code><br></p> <ul> <li>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/encoder/stft_encoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/encoder/stft_encoder.py</a> <code class="language-plaintext highlighter-rouge">STFTEncoder.forward</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/separator/bsrnn_separator.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/separator/bsrnn_separator.py</a> <code class="language-plaintext highlighter-rouge">BSRNNSeparator.forward</code> (If used)<br> </li> <li>â†’ <a href="https://github.com/espnet/espnet/tree/master/espnet2/enh/decoder/stft_decoder.py" style="text-decoration:none;" rel="external nofollow noopener" target="_blank">espnet2/enh/decoder/stft_decoder.py</a> <code class="language-plaintext highlighter-rouge">STFTDecoder.forward</code> (If used)<br> </li> </ul> </body></html>